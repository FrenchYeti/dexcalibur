<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Dexcalibur - Application object finder</title>

    <!--## pages/inc/tpl_css.html ##-->

    <!--## pages/inc/tpl_js_d3.html ##-->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!--## pages/inc/menu.html ##-->
        <!--            <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Hooks<span class="caret"></span></a>
                            <ul class="dropdown-menu">
                              <li><a href="#">Control</a></li>
                              <li role="separator" class="divider"></li>
                              <li><a href="#">Single device logs</a></li>
                              <li><a href="#">Multi devices logs</a></li>
                              <li><a href="#">Observed files</a></li>
                              <li role="separator" class="divider"></li>
                              <li><a href="#">Strategies</a></li>
                            </ul>
                          </li>
                        <li>
                        -->

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">Application object finder</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>

            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder='class("name:Keystore")' id="search_request">
                        <span class="input-group-btn">
                            <button class="btn btn-primary" id="button_search" type="button">
                                <span class="fa fa-search">&nbsp;</span>
                                Search
                            </button>
                            <button class="btn btn-danger" id="button_probeall" type="button">
                                <span class="fa fa-bolt">&nbsp;</span>
                                Probe all
                            </button>
    
                        </span>
                    </div>
                </div>
            </div>

            <b>Search helper (click for add a filter) : </b>
            <div class="row" style="margin-bottom:20px">
                <div class="col-lg-12 pre-request">
                    <a class="badge badge-danger prefilter-clean">clean</a>&nbsp;&nbsp;
                    <a class="badge badge-primary prefilter" prefilt='call("calleed.name:@@")'>find calls to a method</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='call("calleed.name:@@").select("caller")'>find callers of a method</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='call("calleed.name:@@").filter("calleed.__signature__:->")'>use of the field</a>&nbsp;&nbsp;
                    <a class="badge badge-warning prefilter" prefilt='class("name:@@")'>find class by name</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='class("extends.name:@@")'>find class by extended class</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='field("name:@@")'>find field by name</a>&nbsp;&nbsp;
                    <a class="badge badge-warning prefilter" prefilt='method("name:@@")'>find method by name</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='method("args.__signature__:@@")'>find method by arg type</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='method("ret.__signature__:@@")'>find method by return type</a>&nbsp;&nbsp;
                    <a class="badge badge-info prefilter" prefilt='string("value:@@")'>Strings containing</a>&nbsp;&nbsp;
                    <a class="badge badge-pink prefilter" prefilt='array("uid:@@")'>static array by method</a>&nbsp;&nbsp;
                    <a class="badge badge-pink prefilter" prefilt='array("tags:@@")'>static array by tag</a>&nbsp;&nbsp;
                </div>
                <div class="col-lg-12 pre-filter" style="display:none">
                    <a class="badge badge-danger prefilter-clean">clean</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" prefilt='select("_callers")'>xref</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" prefilt='select("caller")'>keep callers</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" prefilt='select("calleed")'>keep calleds</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" prefilt='filter("enclosingClass.name:^@@")'>filter by package</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" prefilt='filter("caller.enclosingClass.name:@@")'>filter by caller class</a>&nbsp;&nbsp;
                    <a class="badge badge-purple prefilter" when="before" prefilt='nocase()'>Case ensensitive</a>&nbsp;&nbsp;
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <table width="100%"  class="table table-striped table-bordered table-hover" id="dataTables-finder">
                        <thead>
                            <tr>
                                <th id="finder-col1" class="col-lg-1">-</th>
                                <th id="finder-col2" class="col-lg-4">-</th>
                                <th id="finder-col3" class="col-lg-4">-</th>
                                <th id="finder-col4" class="col-lg-3">-</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                    <!-- /.table-responsive -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->

        <div class="modal fade" id="probeall_modal" tabindex="-1" role="dialog" aria-labelledby="probeallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="probeallModalLabel">Confirmation</h3>
                    </div>
                    <div class="modal-body">
                        Are you sure to probe <b id="probeall_count"></b> methods ?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Abort</button>
                        <button type="button" class="btn btn-success confirm">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal modal-default" style="display:none" id="class-panel">
            <div class="modal-header">

            </div>
            <div class="modal-body">

            </div>
        </div>


    </div>
    <!-- /#wrapper -->

    <div class="modal fade" id="renameModal" tabindex="-1" role="dialog" aria-labelledby="renameModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
                <h4>Rename</h4>
                <div class="input-group mb-8">
                <input type="text" id="renameModalAlias" class="form-control" style="width:30em" autofocus placeholder="Alias" aria-label="Alias" aria-describedby="basic-addon1">
                <input type="hidden" id="renameModalSubject" class="form-control" style="width:30em" aria-describedby="basic-addon1">
                <input type="hidden" id="renameModalType" class="form-control" style="width:30em" aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>&nbsp;
              <button type="button" class="btn btn-primary aliasconfirm">Save</button>
            </div>
          </div>
        </div>
      </div>

    <div class="modal fade" id="xrefModal" tabindex="-1" role="dialog" aria-labelledby="xrefModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="xrefModalLabel">XRefs</h3>
            </div>
            <div class="modal-body">
                <div name="d3xref" id="d3xref"></div>
                <table width="100%"  class="table table-striped table-bordered table-hover" id="dataTables-xref">
                    <thead>
                        <tr>
                            <th id="xref-col0" class="col-lg-1">Type</th>
                            <th id="xref-col1" class="col-lg-5">Name</th>
                            <th id="xref-col2" class="col-lg-2">Tags</th>
                            <th id="xref-col3" class="col-lg-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="gsetterModal" tabindex="-1" role="dialog" aria-labelledby="gsetterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title" id="gsetterModalLabel">Getter</h3>
            </div>
            <div class="modal-body">
                <table width="100%"  class="table table-striped table-bordered table-hover" id="dataTables-gsetter">
                    <thead>
                        <tr>
                            <th id="xref-col0" class="col-lg-1">Type</th>
                            <th id="xref-col1" class="col-lg-5">Method</th>
                            <th id="xref-col2" class="col-lg-2">Tags</th>
                            <th id="xref-col3" class="col-lg-2">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <!--## pages/inc/tpl_js_end.html ##-->
    <!--## pages/inc/tpl_ace_smali.html ##-->

    <script>

    function setupAceEditor(id){
        var editor = ace.edit(id);
        editor.setTheme("ace/theme/monokai2"); //
//        editor.setTheme("ace/theme/solarized_light"); //

        editor.setOptions({
            maxLines: 50, 
            fontSize: "12pt"
        });
        //editor.setUseWorker(false);
        editor.session.setMode("ace/mode/smali");
    }
    var IdRegister = new Wexcalibur();
     

    function htmlEncode(txt){
        return $('<div />').text(txt).html();
    }

    /* Formatting function for row details - modify as you need */
    function format ( row ) {
        // `d` is the original data object for the row
        let body = '';

        body += "<code style='margin:10px'>";
        body += $("<div />").text(decodeURIComponent(atob(row.script))).html();
        body += "</code>"
            
        return body;
    }


    function getStubType(id){
        let STUB_TYPE=[
            "METHOD",
            "FIELD",
            "ANNOTATION",
            "INSTR",
            "MISSING",
            "CLASS",
            "OBJ_TYPE",
            "BASIC_TYPE",
            "VALUE_CONST",
            "STRING_VALUE",
            "CIRCULAR",
            "VARIABLE",
            "CALL"
        ];

        return STUB_TYPE[id-1];
    }


    var ApplicationMap = {
        tags: null
    };

    const BS = {
        color: {
            purple: 'purple',       
            pink: 'pink',  
            primary: 'primary',         
            info: 'info',         
            warning: 'warning',         
            danger: 'danger',         
            secondary: 'secondary'          
        },
        badge: function(color,data){
            if(BS.color[color]==null) console.error("Given color not exists : ",color);

            return '&nbsp;<a class="badge badge-'+BS.color[color]+'">'+htmlEncode(data)+'</a>'; 
        } 
    };

    const ColorCode = {
        hash: BS.color.primary,
        sha: BS.color.primary,
        md5: BS.color.primary,
        ascii: BS.color.info,
        key: BS.color.pink,
        rsa: BS.color.pink,
        // invoked dynamically
        id: BS.color.purple,
        // loaded from an external file
        led: BS.color.warning
    };

    function findColorCode(tagname){
        for(let i in ColorCode) if(tagname.indexOf(i)>-1) return ColorCode[i];
        return null;
    }

    var Render = {
        methodTag: '<a class="badge badge-success probe">method</a>',
        fieldTag: '<a class="badge badge-primary probe">field</a>',
        classTag: '<a class="badge badge-purple probe">class</a>',
        nativeTag: '<a class="badge badge-pink probe">native</a>'
    };



    function renderClassDetail( row ) {
        let body = '';
        body += '<p><b>Extends :</b>';
            console.log(row);
        if(row.supers != null){
            for(let i=0; i<row.supers.length; i++){
                body += "<br>"+("&nbsp;".repeat(i*3))+"-&nbsp;<a href='finder.html?class="+btoa(encodeURIComponent(row.supers[i].name))+"'>"+(row.supers[i].alias!=null? "<b class='alias-text' >"+htmlEncode(row.supers[i].alias)+"</b>" : "")+"&nbsp;"+htmlEncode(row.supers[i].name)+"</a>";
            }
        }else{
            body += "<i>None</i>";
        }

        /*if(row.extends != null){
            body += "&nbsp;<a href='finder.html?class="+btoa(encodeURIComponent(row.extends.name))+"'>"+htmlEncode(row.extends.alias!=null? row.extends.alias : row.extends.name)+"</a>";
         }else{
            body += "None"
        }*/
        
        body += '</p><p><b>Implements :</b>&nbsp;&nbsp;';
        
        if(row.implements != null){
            //body += "<ul>";
            for(let i=0; i<row.implements.length; i++){
                body += "<a href='finder.html?class="+btoa(encodeURIComponent(row.implements[i]))+"'>"+htmlEncode(row.implements[i])+"</a> <b>/</b> &nbsp;";
            }
            //body += "</ul>"
        }else{
            body += "None"
        }
     
        //body += '<tr>'+
        //    '<td>Implements :</td><td>';
       
/*        for(let i=0; i<row.implements.length; i++){
            body += ((row.implements[i] != null)? row.implements[i].name : 'None')+'<br>';
        }
            
        body += '</td></tr>';
        body += '</table>
        */
        body+= '</p><table class="table table-sm"><thead><tr><th scope="col" class="col-sm-2">Action</th><th scope="col" class="col-sm-1">Type</th><th scope="col">Name</th></thead><tbody>';
         
        if(row.fields != null){
            for(let i in row.fields){
                body += '<tr><td>'+
                    //'<td><a  class="badge badge-secondary probe" field="'+btoa(encodeURIComponent(row.fields[i].__signature__))+'">Probe OFF</a>&nbsp;&nbsp;'+
                    //'<a class="badge badge-secondary" onclick="intercept(\''+btoa(encodeURIComponent(row.fields[i].__signature__))+'\')">Intercept</a>'+
                    //'<a class="badge badge-purple getterof" target="about" field="'+btoa(encodeURIComponent(row.fields[i].__signature__))+'">getter</a>&nbsp;'+
                    '<a class="badge badge-pink fieldxref" target="about" field="'+btoa(encodeURIComponent(row.fields[i].__signature__))+'">xref</a></td><td><i>Field</i></td>'+
                    '<td>';
                if(row.fields[i].alias != null){
                    body += '<b>'+htmlEncode(row.fields[i].alias)+'</b>&nbsp;';
                }
                body += '<a target="about" href="finder.html?field='+btoa(encodeURIComponent(row.fields[i].__signature__))+'">'+htmlEncode(row.fields[i].__signature__)+'</a></td></tr>';
            }
        }

         if(row.methods != null){
             for(let i in row.methods){
                 console.log(row.methods[i]);
                 body += '<tr>'+
                    '<td><a  class="badge badge-'+(row.methods[i].probing? 'success':'primary')+' probe" meth="'+btoa(encodeURIComponent(row.methods[i].__signature__))+'">Probe '+(row.methods[i].probing? 'ON&nbsp;&nbsp;':'OFF')+'</a>&nbsp;&nbsp;'+
                    //'<a  class="badge badge-danger">Intercept</a>'+
                    '<a class="badge badge-purple xrefto" target="about" meth="'+btoa(encodeURIComponent(row.methods[i].__signature__))+'">xref to</a>&nbsp;'+
                    '<a class="badge badge-pink xreffrom" target="about" meth="'+btoa(encodeURIComponent(row.methods[i].__signature__))+'">xref from</a></td><td><i>Method</i></td>'+
                    '<td><a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.methods[i].__signature__))+'">';

                if(row.methods[i].__aliasedCallSignature__ != null)
                    body += '<b>'+htmlEncode(row.methods[i].__aliasedCallSignature__)+'<b>';
                else
                    body += htmlEncode(row.methods[i].__callSignature__);

                    body += '</a></td>'+
                 '</tr>';
             }
         }


        
        body += '</tbody></table>';
        return body;
    }

    function renderXrefGraph(treeData){


        var size = {
            height: 500,
            width: 800
        };
        var options = {
            nodeRadius: 4,
            fontSize: 12
        };

        var  maxLabelLength = 50;

        
        var tree = d3.layout
            .tree()
            .sort(null)
            .size([size.height, size.width - maxLabelLength * options.fontSize])
            .children(function(d) {
                return (!d.data || d.data == null || d.data.length === 0) ? null : d.data;
            });
        

        console.log("init OK");
        var nodes = tree.nodes(treeData.data);

        console.log("data OK");
        var links = tree.links(nodes);

        console.log("links OK");
        var layoutRoot = d3
            .select("#d3xref")
            .append('svg:svg')
            .attr('width', size.width)
            .attr('height', size.height)
            .append('svg:g')
            .attr('class', 'container')
            .attr('transform', 'translate(' + maxLabelLength + ',0)');

        // Edges between nodes as a <path class="link" />
        var link = d3.svg.diagonal().projection(function(d) {
            return [d.y, d.x];
        });

        layoutRoot
            .selectAll('path.link')
            .data(links)
            .enter()
            .append('svg:path')     
            .attr('class', 'link')
            .attr('stroke','#ccc')
            .attr('fill','none')
            .attr('d', link);

        /*
            Nodes as
            <g class="node">
                <circle class="node-dot" />
                <text />
            </g>
        */
        var nodeGroup = layoutRoot
            .selectAll('g.node')
            .data(nodes)
            .enter()
            .append('svg:g')
            .attr('class', 'node')
            .attr('transform', function(d) {
                return 'translate(' + d.y + ',' + d.x + ')';
            });

        nodeGroup
            .append('svg:circle')
            .attr('class', 'node-dot')
            .attr('stroke','red')
            .attr('stroke-width','1')
            .attr('fill','lightsalmon')
            .attr('r', options.nodeRadius);

        nodeGroup
            .append('svg:text')
            .attr('text-anchor', function(d) {
                return d.children ? 'end' : 'start';
            })
            .attr('dx', function(d) {
                var gap = 2 * options.nodeRadius;
                return d.children ? -gap : gap;
            })
            .attr('dy', 3) 
            .text(function(d) {
                return d.name;
            });
    }

    function renderCallerDetail( row ) {
        let body = '';

        caller_type = "Class";
        if(row.caller.indexOf("->")>-1)
            caller_type = "Field";
        else if(row.caller.indexOf("(")>-1)
            caller_type = "Method";

        let calleed_type = "Class";
        if(row.callee.indexOf("->")>-1)
            calleed_type = "Field";
        else if(row.callee.indexOf("(")>-1)
            calleed_type = "Method";

        body += '<table class="table table-sm"><thead><tr><th scope="col">Role</th><th scope="col">Action</th><th scope="col">Type</th><th scope="col">Name</th></thead><tbody>';
        body += '<tr><td><b>Caller</b></td><td>';

        if(row.callee.indexOf("(")==-1)
            body += '<a  class="badge badge-secondary">Probe ON'+
                    '</a>&nbsp;&nbsp;<!--<a  class="badge badge-secondary">Intercept ON</a>-->';
        else
            body += '<a  class="badge badge-success probe" meth="'+btoa(encodeURIComponent(row.caller))+'">Probe ON'+
                    '</a>&nbsp;&nbsp;<!--<a  class="badge badge-danger">Intercept</a>-->';
                /*
            body += '<a  class="badge badge-'+(row.methods[i].probing? 'success':'primary')+' probe" meth="'+btoa(row.methods[i].__signature__)+'">Probe '+(row.methods[i].probing? 'ON':'OFF')+
                    '</a>&nbsp;&nbsp;<a  class="badge badge-danger">Intercept</a>';
                */

        body += '<td>'+caller_type+'</td><td><a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.caller))+'">';
        
        //if(row.caller.alias)
        body += htmlEncode(row.caller)+'</a></td></tr><tr><td><b>Callee</b></td><td>';
           

        if(row.callee.indexOf("(")==-1)
            body += '<a  class="badge badge-secondary">Probe ON'+
                    '</a>&nbsp;&nbsp;<!--<a  class="badge badge-secondary">Intercept ON</a>-->';
        else
            body += '<a  class="badge badge-success probe" meth="'+btoa(encodeURIComponent(row.caller))+'">Probe ON'+
                    '</a>&nbsp;&nbsp;<!--<a  class="badge badge-danger">Intercept</a>-->';
                    
        body += '</td><td>'+calleed_type+'</td><td><a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.callee))+'">'+htmlEncode(row.callee)+'</a></td></tr></table>';

//        $.ajax("/api/method/");
        /* body += '<div class="row"><div class="col-lg-2 col-lg-offset-8">See more</div></div>';
        body += '<code>';
            body += "disass";
        body += '</code>'; */
        return body;
    }

    // print to hexdump format
    function printByteArray(barray, width){
        let d="<pre>";
        let masks = [0x00,0x0000,0x00000000,0x0000000000000000];
        
        for(let i=0; i<barray.length; i++){
            if(i>0 && i%16==0) d+="<br>";

            if(barray[i]<0x10) 
                d+= "0";

            d+= barray[i].toString(16); //('00'.repeat(width>>3))
            d+=" "
        } 
        return d+"</pre>";
    }
    
    function renderDatablockDetail( row ) {
        let body = '', d="";

        body += '<table class="table table-sm">';
        body += '<tr><td><b>Location</b></td><td><a href="finder.html?method='+btoa(encodeURIComponent(row.parent))+'">'+htmlEncode(row.parent)+'</a></td></tr>';
        body += '<tr><td><b>Label</b></td><td>'+htmlEncode(row.name)+'</td></tr>';
        body += '<tr><td><b>Size</b></td><td>'+(parseInt(row.length,10)*parseInt(row.width,10))+'&nbsp; bits</td></tr>';
        body += '<tr><td><b>Entry width</b></td><td>'+row.width+'&nbsp; bits</td></tr>';
        body += '</table>';
        
        body += '<table class="table table-sm"><thead><tr><th scope="col">Tag</th><th scope="col">Data</th><th scope="col">Action</th></thead><tbody>';
        


        for(let i in row.tags){
            d="";
            body += "<tr><td>"+htmlEncode(row.tags[i])+"</td><td>";
            if(row.tags[i]=="ascii"){
                row.values.data.map((x)=>{ d+=String.fromCharCode(x)});
            } 
            else{
                d = "0x";
                row.values.data.map((x)=>{ d+=x.toString(16) });
            }

            body += htmlEncode(d);
        }
        body += "<tr><td>raw</td><td>"+printByteArray(row.values.data,row.width)+"</td><td>";
         
        body += "</tbody></table>"
        return body;
    }

    function renderMethodDetail( row ) {
        let body = '', j=0;

        console.log(row);

        //body += '<table class="table table-sm"><thead><tr><th scope="col">Role</th><th scope="col">Action</th><th scope="col">Type</th><th scope="col">Name</th></thead><tbody>';
        body += '<table class="table table-sm">';
        body += '<tr><td><b>Modifiers</b></td><td>';

        for(let i in row.modifiers){
            if(j==8) body+="<br>";
            if(row.modifiers[i]==true){
                body += '&nbsp;<a  class="badge badge-success">'+i+'</a>';
            }else{
                body += '&nbsp;<a  class="badge badge-secondary">'+i+'</a>';
            }
            j++;
        }

        body += '</td></tr>'; 
        body += '<tr><td>Class</td><td><a href="finder.html?class='+btoa(encodeURIComponent(row.enclosingClass))+'">'+htmlEncode(row.enclosingClass)+'</a></td></tr>';
        body += '<tr><td>Fullname</td><td>'+htmlEncode(row.enclosingClass+'.'+row.name)+'</td></tr>';
        
        for(let i=0;  i<row.args.length; i++){
            sgt = row.args[i].name;
            console.log(row.args[i]);
            body += '<tr><td>Arg '+htmlEncode(i)+'</td><td>';
            
            if(row.args[i].primitive===false)
                body += '<a href="finder.html?class='+btoa(encodeURIComponent(sgt))+'">'+htmlEncode(sgt)+'</a>';
            else
                body += htmlEncode(sgt);

            body += '</td></tr>';
        }

        
        body += '<tr><td>Return</td><td><a class="retlink" href="finder.html?class='+btoa(encodeURIComponent(row.ret.name))+'">'+htmlEncode(row.ret.name)+'</td></tr>';
        body += '</table>';

        let codeID = IdRegister.codeReg.next()

        //body += '<h4>Disassembled bytecode</h4>';
        body += '<div id="'+codeID+'"></div>';
        $.ajax(
            "../api/method/disass/"+encodeURIComponent(btoa(encodeURIComponent(row.__signature__))),
            {
                method: "get",
                statusCode: {
                    200: function(data){
                        data = JSON.parse(data);
                        let code = $("#"+codeID);
                        let codeBody = "";
                        console.log(data,code);
                        for(let i=0; i<data.disass.length; i++){
                            codeBody += "\n";
                            if(data.disass[i].tag!=null){
                                codeBody += "."+data.disass[i].tag.substr(1)+"\n";
                            }
                            if(data.disass[i].instr.length>0){
                                //console.log(data.disass[i].instr);
                                for(let j=0; j<data.disass[i].instr.length; j++){
                                    if(data.disass[i].instr[j].value == null){
                                        console.log("Instr is null : <"+i+","+j+">");
                                    }else{
                                        if(data.disass[i].instr[j].value.indexOf("move-result-object")==0)
                                            codeBody += "\t"+data.disass[i].instr[j].value+"\n";
                                        else    
                                            codeBody += data.disass[i].instr[j].value+"\n";
                                    }
                                }   
                            }
                        }
                        code.html(codeBody);
                        //code.html("var a=new String('test');");
                        setupAceEditor(codeID);
                    }
                }
            }
        );
        return body;
    }



    $(document).ready(function() {

        $.ajax(
            "../api/tags",
            {
                method:"get",
                statusCode: {
                    200: function(data){
                        let tags = JSON.parse(data), cc=null;
                        for(let i=0; i<tags.length;i++){
                            cc = findColorCode(tags[i]);
                            if(cc==null) console.log("Need more color code"); 
                            for(let j=0; j<tags[i].length;j++){
                                ApplicationMap.tags.push(tags[i][j]) = tags[i];
                            }
                        }
                    }
                }
            }
        );
       

        let clsTable = $('#dataTables-finder').DataTable({
            searching: false,
            paging: false,
            columns: [
                {
                    "className":      'details-control',
                    "orderable":      false,
                    "data":           null,
                    "defaultContent": ''
                },
                {  "defaultContent": '' },
                {  "defaultContent": '' },
                { 
                    render: function(data, type, row, meta ){
                        if(row.name != null)
                            return '<a  class="badge badge-success probe" meth="'+btoa(encodeURIComponent(row.name))+'">ON</a>';
                        else    
                            return '';
                    }
                }
            ],
            responsive: true
        });

        let gsetterTable = $('#dataTables-gsetter').DataTable({
            searching: false,
            paging: false,
            columns: [{
                    render: function(data, type, row, meta ){
                        if(row.t=='s')
                            return BS.badge("purple","set");
                        else
                            return BS.badge("pink","get");
                    }
                },
                {  
                    // render called/caller name
                    render: function(data, type, row, meta ){
                        //console.log("xref :",row);
                        return '<a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.s))+'">'+htmlEncode(row.s)+'</a>';                            
                    }
                 },
                {  
                    // render tags
                    render: function(data, type, row, meta ){
                        let t = "";
                        if(row.tags==null) return t;
                        for(let i=0; i<row.tags.length; i++){
                            switch(row.tags[i]){
                                case "di":
                                    t += '&nbsp;<span class="badge badge-success">internal</span>'
                                    break;
                                case "dd":
                                    t += '&nbsp;<span class="badge badge-purple">dynamic</span>'
                                    break;
                                case "id":
                                    t += '&nbsp;<span class="badge badge-purple">invoked</span>'
                                    break;
                            }
                        }
                        return t;
                    }},
                { 
                    // render probing btn
                    render: function(data, type, row, meta ){
                        if(row.s.indexOf("<clinit>")>-1)
                            return ''; //<a class="badge badge-secondary" tip="Class init cannot be hooked">Probe</a>';
                        else
                            return '<a  class="badge badge-'+(row.probing? 'success':'primary')+' probe" meth="'+btoa(encodeURIComponent(row.s))+'">Probe '+(row.probing? 'ON&nbsp;&nbsp;':'OFF')+'</a>';
                    }
                }
            ],
            responsive: true
        });

        let xrefTable = $('#dataTables-xref').DataTable({
            searching: false,
            paging: false,
            columns: [{
                    render: function(data, type, row, meta ){
                        if(row.t != null){
                            console.log(row);
                            if(row.t=='f')
                                return 'Field';
                            else if(row.t=='m')
                                return 'Method';                            
                            else
                                return 'Class';
                        }else{
                            return 'Method';
                        }
                    }
                },
                {  
                    // render called/caller name
                    render: function(data, type, row, meta ){
                        //console.log("xref :",row);
                        if(row.t != null)
                            if(row.t=='f')
                                return '<a target="about" href="finder.html?field='+btoa(encodeURIComponent(row.s))+'">'+htmlEncode(row.s)+'</a>';
                            else if(row.t=='m')
                                return '<a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.s))+'">'+htmlEncode(row.s)+'</a>';                            
                            else
                                return '<a target="about" href="finder.html?class='+btoa(encodeURIComponent(row.s))+'">'+htmlEncode(row.s)+'</a>';
                        else{
                            console.log("Else case trigged");
                            let t = '<a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.s))+'">';
                            if(row.a != null)
                                return t+htmlEncode(row.a)+'</a><br><i>'+htmlEncode(row.s)+'</i>';
                            else
                                return t+htmlEncode(row.s)+'</a>';
                        }

                    }
                 },
                {  
                    // render tags
                    render: function(data, type, row, meta ){
                        let t = "";
                        if(row.tags==null) return t;
                        for(let i=0; i<row.tags.length; i++){
                            switch(row.tags[i]){
                                case "di":
                                    t += '&nbsp;<span class="badge badge-success">internal</span>'
                                    break;
                                case "dd":
                                    t += '&nbsp;<span class="badge badge-purple">dynamic</span>'
                                    break;
                                case "id":
                                    t += '&nbsp;<span class="badge badge-purple">invoked</span>'
                                    break;
                            }
                        }
                        return t;
                    }},
                { 
                    // render probing btn
                    render: function(data, type, row, meta ){
                        if(row.s.indexOf("<clinit>")>-1 || (row.t!=null && row.t=='f'))
                            return ''; //<a class="badge badge-secondary" tip="Class init cannot be hooked">Probe</a>';
                        else
                            return '<a  class="badge badge-'+(row.probing? 'success':'primary')+' probe" meth="'+btoa(encodeURIComponent(row.s))+'">Probe '+(row.probing? 'ON&nbsp;&nbsp;':'OFF')+'</a>';
                    }
                }
            ],
            responsive: true
        });

        function renderXrefModal( ref, from ) {
            let body = '', j=0;

            if(from)
                $('#xrefModalLabel').html("XRef from <h4>"+htmlEncode(decodeURIComponent(atob(ref)))+"</h4>");
            else
                $('#xrefModalLabel').html("XRef to <h4>"+htmlEncode(decodeURIComponent(atob(ref)))+"</h4>");

            
            xrefTable.clear();
            xrefTable.draw();   
            $.ajax(
                "../api/method/xref/"+ref,
                {
                    method: "get",
                    data: {
                        type: (from ? "from":"to")
                    },
                    statusCode: {
                        200: function(data){
                            xrefTable.clear();
                            xrefTable.rows.add(JSON.parse(data).data);
                            xrefTable.draw();
                        },
                        404: function(data){
                            alert("Error : "+JSON.parse(data).err);
                            console.log(data);
                        },
                        500: function(data){
                            alert("Fatal error : "+JSON.parse(data).err);
                            console.log(data);
                        }
                    }
                }
            );

            $("#xrefModal").modal();
            return true;
        }

        function renderGsetterModal( ref) {
            let body = '', j=0;

            $('#gsetterModalLabel').html("Setters & getters of <h4>"+htmlEncode(decodeURIComponent(atob(ref)))+"</h4>");
  
            gsetterTable.clear();
            gsetterTable.draw();   
            $.ajax(
                "../api/field/xref/"+ref,
                {
                    method: "get",
                    statusCode: {
                        200: function(data){
                            gsetterTable.clear();
                            gsetterTable.rows.add(JSON.parse(data).data);
                            gsetterTable.draw();
                        },
                        404: function(data){
                            alert("Error : "+JSON.parse(data).err);
                            console.log(data);
                        },
                        500: function(data){
                            alert("Fatal error : "+JSON.parse(data).err);
                            console.log(data);
                        }
                    }
                }
            );

            $("#gsetterModal").modal();
            return true;
        }

        function renderClassTable(table){
            $("#finder-col1").html("");
            $("#finder-col2").html("Package");
            $("#finder-col3").html("Name");
            $("#finder-col4").html("Action");

            table.destroy();
            return $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    {  
                        render: function(data, type, row, meta ){
                            console.log(data, type, row, meta);
                            return row.fqcn;
                            /*
                            if(row.package != undefined)
                                return row.package.name;
                            else{
                                console.log(row);
                                return "-";
                            }*/
                        }
                    },
                    {   
                        render: function(data, type, row, meta ){
                            let b = "";
                            if(row.alias != null){
                                b = '<b>'+htmlEncode(row.alias)+'</b>&nbsp;<i class="secondary-text">'+htmlEncode(row.name)+'</i>';
                            }
                            else if(row.name != null){
                                if(row.name.lastIndexOf("$")>row.name.lastIndexOf('.')){
                                    b = row.name.substr(row.name.lastIndexOf('.')+1);
                                }else{
                                    b = row.simpleName;
                                }
                            }else{
                                console.log("Unable to render Class : "+row);
                            }

                            // loaded from an external dex file
                            if(row.tags.indexOf("led") > -1){
                                b += BS.badge(
                                        findColorCode("led")
                                        , "external");
                            }


                            return b;
                            /*
                            if(row.enclosingClass != undefined)
                                return row.enclosingClass.simpleName+"$"+row.simpleName;
                            else{
                                return row.simpleName;
                            }*/
                        }
                    },
                    { 
                        render: function(data, type, row, meta ){
                            let b='<a  class="badge badge-info rename" ename="'+btoa(encodeURIComponent(row.name))+'" subt="class" subject="'+btoa(encodeURIComponent(row.name))+'">Rename</a>';

                            return b;
                        }
                    }
                ],
                responsive: true
            });
        }

        function renderMethodTable(table){
            $("#finder-col1").html("");
            $("#finder-col2").html("Class");
            $("#finder-col3").html("Method");
            $("#finder-col4").html("Action");

            table.destroy();
            return $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { 
                        render: function(data, type, row, meta ){
                            return ((row.enclosingClass!=null)? htmlEncode(row.enclosingClass) : '[Missing]');
                        }
                    },
                    {  
                        render: function(data, type, row, meta ){
                            return '<span meth='+btoa(encodeURIComponent(row.__signature__))+'>'+(row.alias!=null? '<b>'+htmlEncode(row.alias)+'</b>&nbsp;<i class="secondary-text">'+htmlEncode(row.__signature__)+'</i>':'&nbsp;'+htmlEncode(row.__signature__))+'</span>';
                        }
                    },
                    { 
                        
                        render: function(data, type, row, meta ){
                            //console.log(row.__signature__);
                            let b='<a  class="badge badge-primary probe" meth="'+btoa(encodeURIComponent(row.__signature__))+'">Probe</a>&nbsp;';
                            // b += '&nbsp;<a  class="badge badge-secondary cfg" meth="'+btoa(encodeURIComponent(row.__signature__))+'">Call Graph</a>&nbsp;';
                            // b += '&nbsp;<a  class="badge badge-secondary seemore" meth="'+btoa(encodeURIComponent(row.__signature__))+'">See more</a>';
                            b += '<a  class="badge badge-info rename" ename="'+btoa(encodeURIComponent(row.alias!=null? row.alias : row.name))+'" subt="meth" subject="'+btoa(encodeURIComponent(row.__signature__))+'">Rename</a>';
                            b += '&nbsp;<a  class="badge badge-purple xrefto" meth="'+btoa(encodeURIComponent(row.__signature__))+'">xref to</a>';
                            b += '&nbsp;<a  class="badge badge-pink xreffrom" meth="'+btoa(encodeURIComponent(row.__signature__))+'">xref from</a>';
                            b += '&nbsp;<a  class="badge badge-warning seegraph" meth="'+btoa(encodeURIComponent(row.__signature__))+'">Xgraph</a>';

                            return b;
                            /*
                            if(row.enclosingClass != undefined)
                                return row.enclosingClass.simpleName+"$"+row.simpleName;
                            else{
                                return row.simpleName;
                            }*/
                        }
                    }
                ],
                responsive: true
            });
        }

        function renderFieldTable(table){
            $("#finder-col1").html("");
            $("#finder-col2").html("Class");
            $("#finder-col3").html("Field");
            $("#finder-col4").html("Action");

            table.destroy();
            return $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { 
                        render: function(data, type, row, meta ){
                            if(row.enclosingClass!=null){
                                return "<a href='finder.html?class="+btoa(encodeURIComponent(row.enclosingClass.name))+"'>"+(row.enclosingClass.alias!=null? "<b class='alias-text' >"+htmlEncode(row.enclosingClass.alias)+"</b>" : "")+"&nbsp;"+htmlEncode(row.enclosingClass.name)+"</a>";
                            }else
                                return '[Missing]';
                        }
                    },
                    {  
                        render: function(data, type, row, meta ){
                            return (row.alias!=null? '<b>'+htmlEncode(row.alias)+'</b>&nbsp;':'&nbsp;')+htmlEncode(row.__signature__);
                        }
                    },
                    {   
                        render: function(data, type, row, meta ){
                            let b='<a  class="badge badge-info rename" ename="'+btoa(encodeURIComponent(row.name))+'" subt="field" subject="'+btoa(encodeURIComponent(row.__signature__))+'">Rename</a>&nbsp;';
                            b+='<a class="badge badge-pink fieldxref" target="about" field="'+btoa(encodeURIComponent(row.__signature__))+'">xref</a>';
                            return b;
                        }
                    }
                ],
                responsive: true
            });
        }

        function renderCallerTable(table){
            $("#finder-col1").html("");
            $("#finder-col2").html("Caller");
            $("#finder-col3").html("Callee");
            //$("#finder-col4").html("Action");
            $("#finder-col4").css("display","none");

            table.destroy();
            return $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { 
                        render: function(data, type, row, meta ){
                            return (row.caller!=null)? htmlEncode(row.caller) : '[Missing]';
                        }
                    },
                    {  
                        render: function(data, type, row, meta ){
                            if(row.callee !== undefined){
                                let txt = ''
                                if(row.callee.indexOf('(')>-1){
                                    txt +=  Render.methodTag;
                                }else if(row.callee.indexOf('->')>-1){
                                    txt +=  Render.fieldTag;
                                    if(row.instr=="SETTER")
                                        txt += BS.badge("purple","set");
                                    else
                                        txt += BS.badge("pink","get");
                                }else{
                                    txt +=  Render.classTag;
                                }
                                return txt+"&nbsp;"+htmlEncode(row.callee);

                            }else
                                return '';
                        }
                    },
                    { 
                        "defaultContent": ''
                    }
                ],
                responsive: true
            });
        }

        function renderValuesTable(table){
            $("#finder-col1").html("");
            //$("#finder-col1").addClass("col-md-1");
            $("#finder-col2").html("Value");
            //$("#finder-col2").addClass("col-md-5");
            $("#finder-col3").html("Caller");
            //$("#finder-col3").addClass("col-md-5");
            $("#finder-col4").html("");//style("display","none");
            //$("#finder-col4").addClass("col-md-1");

            table.destroy();
            let t= $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        //"className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": '',
                        "width":"5%"
                    },
                    { 
                        render: function(data, type, row, meta ){
                            if(row.value.length > 60){
                                let b="";
                                for(let i=0; i<row.value.length/60; i++){
                                    b += htmlEncode(row.value.substr(i*60,60))+"<br>";
                                }
                                return b;
                            }else
                                return htmlEncode(row.value);
                        },
                        "width":"40%"
                    },
                    {  
                        render: function(data, type, row, meta ){
                            return '<a target="about" href="finder.html?method='+btoa(encodeURIComponent(row.instr.method))+'">'+htmlEncode(row.instr.method)+'</a>';
                        },
                        "width":"40%"
                    },
                    {
                         render: function(data, type, row, meta ){
                            return '<a  class="badge badge-success probe" meth="'+btoa(encodeURIComponent(row.instr.method))+'">Probe</a>&nbsp;';
                         },
                        "width":"15%"

                    }
                ],
                responsive: false
            });
            t.columns.adjust();
            return t;
        }

        
        function renderDatablockTable(table){
            $("#finder-col1").html("");
            $("#finder-col2").html("Position");
            $("#finder-col3").html("Tags");
            $("#finder-col4").html("Action");

            table.destroy();
            return $('#dataTables-finder').DataTable({
                searching: false,
                paging: false,
                columns: [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { 
                        render: function(data, type, row, meta ){
                            return (row.uid!=null)? htmlEncode(row.uid) : '[Missing]';
                        }
                    },
                    {  
                        render: function(data, type, row, meta ){
                            let r="";
                            if(row.tags!=null){
                                for(let i=0; i<row.tags.length; i++){
                                    r += BS.badge(
                                        findColorCode(row.tags[i])
                                        , row.tags[i]);
                                }
                            }
                            return r;
                        }
                    },
                    { 
                        
                        render: function(data, type, row, meta ){
                            console.log(row);
                            if(row.uid.indexOf("<clinit>")>-1)
                                return '<a class="badge badge-secondary" tip="Class init cannot be hooked">Probe</a>';
                            else
                                return '<a  class="badge badge-info probe" meth="'+btoa(encodeURIComponent(row.parent))+'">Probe</a>';
                        }
                    }
                ],
                responsive: true
            });
        }

        function renderBodyTable(data){
            
            //console.log(typeof data, data instanceof Array, data instanceof Object);
            
            if((data instanceof Array)==false)
                data = [data];

                console.log(data);
            
                
            clsTable.clear();

            if(data[0].package !== undefined){
                clsTable = renderClassTable(clsTable);
            }
            else if(data[0].args !== undefined){
                clsTable = renderMethodTable(clsTable);
            }
            else if(data[0].type !== undefined){
                clsTable = renderFieldTable(clsTable);
            }
            else if(data[0].caller !== undefined){
                clsTable = renderCallerTable(clsTable);
            }
            else if(data[0].value !== undefined){ 
                clsTable = renderValuesTable(clsTable);
            }
            else if(data[0].width !== undefined){
                clsTable = renderDatablockTable(clsTable);
            }

            //clsTable.clear();
            clsTable.rows.add(data);
            clsTable.draw();
        }

        htmlEncode = function(txt){
            return $("<div />").text(txt).html();
        }

        //$('#probelogs').
        $('#dataTables-finder tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = clsTable.row( tr );
            //console.log(row.child);

            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                let rd = row.data();
                if(rd.package != null){
                    row.child( renderClassDetail(row.data()) ).show();
                    tr.addClass('shown');
                }
                else if(rd.args != null){
                    row.child( renderMethodDetail(row.data()) ).show();
                    tr.addClass('shown');
                }
                else if(rd.type != null){
                    //row.child( renderFieldDetail(row.data()) ).show();
                    //tr.addClass('shown');
                }
                else if(rd.caller != null){
                    row.child( renderCallerDetail(row.data()) ).show();
                    tr.addClass('shown');
                }
                else if(rd.value != null){
                    row.child( renderStringDetail(row.data()) ).show();
                    tr.addClass('shown');
                }
                else if(rd.values != null){
                    row.child( renderDatablockDetail(row.data()) ).show();
                    tr.addClass('shown');
                }

            }
        } );

        
        $(document).on("click",".probe",function(){
            let DOM_PROBE =$(this);
            let meth = $(this).attr("meth");

            $.ajax('../api/probe/'+meth,{
                method: 'post',
                statusCode: {
                    200: function(data, err){

                        //console.log(DOM_PROBE,hasClass("badge-primary"));
                        if(JSON.parse(data).enable){
                            if(DOM_PROBE.hasClass("badge-primary"))
                                DOM_PROBE.removeClass("badge-primary");

                            DOM_PROBE.addClass("badge-success");
                            DOM_PROBE.text("Probe ON").html();
                        }else{

                            if(DOM_PROBE.hasClass("badge-success"))
                                DOM_PROBE.removeClass("badge-success");

                            DOM_PROBE.addClass("badge-primary");
                            DOM_PROBE.text("Probe OFF").html();
                        }
                    },
                    404: function(){
                        //alert("Failed to add probe (see logs)")
                    }
                }
            })
        });


        $(document).on("click",".xreffrom",function(e){
            let DOM_PROBE =$(this);
            let meth = $(this).attr("meth");

            renderXrefModal(meth,true);
        });
        $(document).on("click",".xrefto",function(e){
            let DOM_PROBE =$(this);
            let meth = $(this).attr("meth");

            renderXrefModal(meth,false);
        });



        $(document).on("click",".fieldxref",function(e){
            //let DOM_PROBE =$(this);
            let field = $(this).attr("field");

            renderGsetterModal(field);
        });

        $(document).on("click",".seegraph",function(e){
            let meth = $(this).attr("meth");

            window.open("/pages/graph_d3.html?type=cgfrom&meth="+meth);
        });

        var GLOBAL = {
            results: null
        };

        $("#button_search").click(function(){
            let val = $("#search_request")[0].value;
            
            json = JSON.stringify({ search: val });

            $.ajax('../api/finder',{
                method: 'get',
                data: {
                    search: encodeURIComponent(btoa(encodeURIComponent(val))),
                    _t: (new Date()).getTime()
                },
                statusCode: {
                    200: function(data){
                        data = JSON.parse(data);
                        //console.log(data);
                        //$("#probelogs").html("");
                        //renderHeaderTable(data.data);
                        if(data.data == null || data.data.length==0){
                            alert("No matches found !");
                        }else{
                            GLOBAL.results = data.data;
                            console.log(data.data);
                            renderBodyTable(data.data);

                            // auto expand, il single row 
                            if(data.data.length == undefined)/*g_search_type === SEARCH.SINGLE)*/{
                                $('#dataTables-finder td.details-control').trigger('click');
                            }
                        }

                    },
                    404: function(data){
                        alert("No matches found !");
                        //console.log(data);
                        //alert("Failed to add probe (see logs)")
                    }
                }
            })
        });


        //dmTable.ajax.url("../api/device").load();
        $('#dm-refresh-btn').click(()=>{
            clsTable.ajax.reload();
        });


        // predefine filter event
        $('.pre-request .prefilter').click(function(elem){
            let filt = $(this).attr("prefilt"), token="", dot="";

            if(filt.indexOf("@@")>-1){
                token = prompt("Type the value for the filter :");
                if(token == null) return;
                
                filt = filt.replace("@@",token);
            }

            if($("#search_request")[0].value.length > 0)
                dot = ".";

            if("before"!=$(this).attr("when"))
                $("#search_request")[0].value = $("#search_request")[0].value+dot+filt;
            else
                $("#search_request")[0].value = filt+dot+$("#search_request")[0].value;

            $("#button_search").trigger("click");
            $(".pre-request").css("display","none");
            $(".pre-filter").css("display","block");
        });

        $('.pre-filter .prefilter').click(function(elem){
            let filt = $(this).attr("prefilt"), token="", dot="";

            if(filt.indexOf("@@")>-1){
                token = prompt("Type the value for the filter :");
                filt = filt.replace("@@",token);
            }

            if($("#search_request")[0].value.length > 0)
                dot = ".";

            if("before"!=$(this).attr("when"))
                $("#search_request")[0].value = $("#search_request")[0].value+dot+filt;
            else
                $("#search_request")[0].value = filt+dot+$("#search_request")[0].value;

            $("#button_search").trigger("click");
        });

        $('.prefilter-clean').click(function(elem){
            $("#search_request")[0].value = "";
            $(".pre-request").css("display","block");
            $(".pre-filter").css("display","none");
        });

        $('#button_probeall').click(function(e){
            
            $('#probeall_count').html(
                GLOBAL.results!=null? (GLOBAL.results.length!=null? GLOBAL.results.length : 1) : 0 
            );
            $('#probeall_modal').modal();
        });

        $('#probeall_modal .confirm').click(function(e){
            let probes = $(".probe");
            for(let i=0; i<probes.length; i++){
                probes[i].click();
            }
            $('#probeall_modal').modal('toggle');
        });

        $(document).on("click",".rename",function(e){
            $("#renameModalSubject").val($(this).attr("subject"));
            $("#renameModalType").val($(this).attr("subt"));
            $("#renameModalAlias").val(decodeURIComponent(atob($(this).attr("ename"))));
            $("#renameModal").modal();
        });

        $(document).on("click",".aliasconfirm",function(e){
            let subject = $("#renameModalSubject").val();
            let type = $("#renameModalType").val();
            let alias = $("#renameModalAlias").val();
            let url = null;
            let cell = null;

            if(type=="meth"){
                url = "../api/method/"+subject;
            }else if(type=="field"){
                url = "../api/field/"+subject;
            }else if(type=="class"){
                url = "../api/class/"+subject;
            }
            else
                return;

            $.ajax(
                url,
            {
                method: "put",
                data: { alias:alias },
                statusCode: {
                    200: function(data,err){
                        $('#renameModal').modal('toggle');

                    },
                    404: function(data,err){
                        alert(data.error);
                    }
                }
            });

        });

        function setLocationQuery(){
            let q = location.href.indexOf('?');
            if(q==-1){
                location.query = "";
            } else{
                location.query = location.href.substr(
                    q+1,
                    location.href.length-q-1-location.hash.length
                );                
            }
        }

        setLocationQuery();
        //console.log(location,location.query.length>0);
        
        if(location.query.length>0){
            let o = location.query.indexOf("=");
            let tag = location.query.substr(0, o);
            let req = decodeURIComponent(atob(location.query.substr(o+1)));

            //console.log("parsing hash",tag,req);
            switch(tag){
                case "xrefcls":
                    $("#search_request")[0].value = 'call("calleed.enclosingClass.name:'+req+'")';
                    $("#button_search").trigger("click");
                    break;
                case "xreffield":
                    $("#search_request")[0].value = 'call("calleed.__signature__:'+req+'")';
                    $("#button_search").trigger("click");
                    break;
                case "xrefmeth":
                    $("#search_request")[0].value = 'call("calleed.__signature__:'+req+'")';
                    $("#button_search").trigger("click");
                    break;
                case "method":
                    $("#search_request")[0].value = 'get.method("'+req+'")';
                    $("#button_search").trigger("click");
                    break;
                case "field":
                    $("#search_request")[0].value = 'get.field("'+req+'")';
                    $("#button_search").trigger("click");
                    break;
                case "class":
                    $("#search_request")[0].value = 'get.class("'+req+'")';
                    $("#button_search").trigger("click");
                    break;
            }
        }
    });


    </script>

</body>

</html>
